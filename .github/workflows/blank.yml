name: "Build Export Templates"
on: push

jobs:
  build-templates:
    name: Build All Export Templates
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clone Godot Engine Source
      run: |
        git clone https://github.com/godotengine/godot.git
        cd godot
        git checkout 4.3
    
    - name: Install SCons
      run: |
        python3 -m pip install scons
    
    - name: Install MinGW
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64
        sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix
    
    - name: Set Up Emscripten
      run: |
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        ./emsdk install 3.1.64
        ./emsdk activate 3.1.64
        echo "EMSDK_PATH=$(pwd)" >> $GITHUB_ENV
        echo "PATH=$(pwd)/upstream/emscripten:$(pwd):$PATH" >> $GITHUB_ENV
    
    - name: Clean Build Directory
      run: |
        cd godot
        scons -c
    
    - name: Build Export Template Web
      run: |
        cd godot
        scons -j 4 p=web target=template_release verbose=1 use_ptrcall=yes use_threads=yes
        ls -la bin/
        cp bin/godot.web.template_release.wasm32.zip web_release.zip
    
    - name: Upload Web Template as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: web-template
        path: godot/templates/web_release.zip
